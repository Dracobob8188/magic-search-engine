#!/usr/bin/env ruby

require_relative "../search-engine/lib/card_database"

class CardPrinting
  def path_lq
    Pathname("frontend/public/cards/#{set_code}/#{number}.png")
  end

  def path_hq
    Pathname("frontend/public/cards_hq/#{set_code}/#{number}.png")
  end
end

class PrintPicsStatistics
  attr_reader :db

  def initialize
    @db = CardDatabase.load
    @all = 0
    @hq = 0
    @lq = 0
    @by_set = {}
  end

  def call
    db.printings.each do |card|
      @all += 1
      @lq  += 1 if card.path_lq.exist?
      @hq  += 1 if card.path_hq.exist?
    end

    db.printings.each do |card|
      set = card.set_code
      @by_set[set] ||= Hash.new(0)
      @by_set[set]["total"] += 1
      if card.path_hq.exist?
        @by_set[set]["hq"] += 1
      elsif card.path_lq.exist?
        @by_set[set]["lq"] += 1
      else
        @by_set[set]["none"] += 1
      end
    end

    # Summary
    puts "Cards: #{@all}"
    puts "LQ: #{@lq}"
    puts "HQ: #{@hq}"
    puts ""

    # Details
    @by_set
      .select{|set_name, stats|
        # Online only sets can't possibly have HQ scans
        if db.sets[set_name].online_only?
          stats["none"] > 0
        else
          stats["lq"] + stats["none"] > 0
        end
      }
      .sort_by{|set_name, stats|
        set = db.sets[set_name]
        [-set.release_date.to_i_sort, set.name]
      }
      .each do |set_name, stats|
      summary = [
        ("#{stats["hq"]} HQ" if stats["hq"] > 0),
        ("#{stats["lq"]} LQ" if stats["lq"] > 0),
        ("#{stats["none"]} No Picture" if stats["none"] > 0),
      ].compact.join(", ")
      puts "#{set_name}: #{summary}"
    end
  end
end

PrintPicsStatistics.new.call
